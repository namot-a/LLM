# –ú–∏–≥—Ä–∞—Ü–∏—è 002: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º

## üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:

1. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `allowed_roles` –≤ —Ç–∞–±–ª–∏—Ü—É `chunks`
2. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `allowed_roles` –≤ —Ç–∞–±–ª–∏—Ü—É `notion_pages`
3. –°–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–æ–ª—è–º
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–æ–ª–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ Railway:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Railway CLI (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Railway
railway connect

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
cat migrations/002_add_roles.sql | railway run psql $DATABASE_URL
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç

```bash
# –ù–∞ Railway –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É
railway run python apply_migration.py
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Railway Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ Railway Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä–æ–π—Ç–µ PostgreSQL plugin
4. –ù–∞–∂–º–∏—Ç–µ "Connect" ‚Üí "Query"
5. –í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `migrations/002_add_roles.sql`
6. –ù–∞–∂–º–∏—Ç–µ "Execute"

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ DATABASE_URL –∏–∑ Railway
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
psql "postgresql://user:pass@host:port/db" < migrations/002_add_roles.sql
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∏ —Å–æ–∑–¥–∞–Ω—ã
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'notion_pages' 
  AND column_name = 'allowed_roles';

SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'chunks' 
  AND column_name = 'allowed_roles';
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å: `allowed_roles | ARRAY`

## üìã –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

1. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Railway (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
2. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ `https://your-app.vercel.app/notion`
3. ‚úÖ –î–æ–±–∞–≤—å—Ç–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç —Å –≤—ã–±–æ—Ä–æ–º —Ä–æ–ª–µ–π
4. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Telegram —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏

## üîÑ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

```sql
-- –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏
ALTER TABLE chunks DROP COLUMN IF EXISTS allowed_roles;
ALTER TABLE notion_pages DROP COLUMN IF EXISTS allowed_roles;

-- –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å
DROP INDEX IF EXISTS idx_chunks_allowed_roles;
```

## üìä –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏:

### `documents`
- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ Notion
- –°–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –°–æ–¥–µ—Ä–∂–∞—Ç: id, notion_page_id, title, url, dates
- –°–≤—è–∑—å: 1 document ‚Üí –º–Ω–æ–≥–æ chunks

### `notion_pages`
- –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `/notion`
- –°–æ–¥–µ—Ä–∂–∞—Ç: URL, —Å—Ç–∞—Ç—É—Å, allowed_roles
- –ù–µ —Ö—Ä–∞–Ω—è—Ç –∫–æ–Ω—Ç–µ–Ω—Ç, —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

### `chunks`
- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –°–æ–¥–µ—Ä–∂–∞—Ç embeddings –¥–ª—è –ø–æ–∏—Å–∫–∞
- –¢–µ–ø–µ—Ä—å —Å `allowed_roles` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ RAG –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤

**Workflow:**
```
notion_pages (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) 
    ‚Üì —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
documents + chunks (–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞)
    ‚Üì retrieval
–æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞
```

